<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">

		<title>Fun with the Gitlab API and PHP</title>

		<link href="dist/reset.css" rel="stylesheet">
		<link href="dist/reveal.css" rel="stylesheet">
		<link href="dist/theme/code711.css" rel="stylesheet">

		<!-- Theme used for syntax highlighted code -->
		<link href="plugin/highlight/monokai.css" rel="stylesheet">
	</head>
	<body>
		<img class="logos7" src="sudhaus7.svg"/>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1>Fun with the Gitlab API and PHP</h1>
					<h4>IPC Munich 2025</h4>
					<h4>Frank Berger</h4>
				</section>
				<section>
					<div class="twocolumn">
						<div>
							<h4>A bit about me</h4>
							<ul>
								<li>Frank Berger</li>
								<li>Head of Engineering at sudhaus7.de, a label of the B-Factor GmbH, member of the code711.de network</li>
								<li>Started as an Unix  Systemadministrator who also develops in 1996</li>
								<li>Working with PHP since V3</li>
								<li>Does TYPO3 since 2005</li>
							</ul>
						</div>
						<div>
							<img src="Frank.jpg"/>
						</div>
					</div>
				</section>

				<section>
					<h2>About the API</h2>
                    <p class="fragment">Gitlab offers a REST API</p>
                    <p class="fragment">Almost all tasks can be done through the API</p>
                    <p class="fragment">Without using a git binary</p>
                    <p class="fragment">https://docs.gitlab.com/api/rest/</p>
				</section>

                <section>
                    <h2>PHP Clients</h2>
                    <p>m4tthumphrey/php-gitlab-api (mentioned by Gitlab itself)</p>
                    <p class="fragment">Verb-complete implementation</p>
                    <p class="fragment">Pure userland implementation without the need of a git binary or extension</p>
                </section>

                <section>
                    <h2>Creating a personal access token</h2>
                    <img src="personal-access-token.png"/>
                    <p class="fragment">A personal access token will inherit the user level of the  user on the respecting project!</p>
                </section>

                <section>
                    <h2>Creating a project access token</h2>
                    <img src="project-access-token.png"/>

                    <p class="fragment">With a project level access token, the project-id or project-path must be provided for almost all API-actions</p>
                </section>

                <section>
                    <h2>What to define in the token</h2>
                    <img src="token-creation.png"/>
                </section>

                <section>
                    <h2>Other Tokens</h2>
                    <h4>OAUTH2 Token</h4>
                    <p>An OAUTH2 Token can be used as well, with Gitlab as an IdP, but that is probably not practical for automated processes</p>
                    <h4>CI_JOB_TOKEN</h4>
                    <p>When running a tool inside a CI/CD queue,  the CI_JOB_TOKEN can be used to access the Gitlab API</p>
                </section>

                <section>
                    <h2>Connect to the Gitlab Server</h2>
                    <pre><code class="hljs php" data-line-numbers="|5" data-trim>
$client = new Gitlab\Client();
$client->setUrl(getenv('GITLAB_SERVER')); // https://gitlab.com/
$client->authenticate(
    getenv('GITLAB_ACCESS_TOKEN'), // glpat-XXXXX-XXX....
    Gitlab\Client::AUTH_HTTP_TOKEN
);
                    </code></pre>
                    <p class="fragment">Any PSR-18 HTTP-Client can be injected as well</p>
                </section>

                <section>
                    <h2>Let's try to list some projects</h2>
                    <pre><code class="hljs php" data-line-numbers="|2" data-trim>
$projects = $client
    ->projects()
    ->all();

foreach($projects as $project) {
    printf("%d %s (%s)\n",
        $project['id'],
        $project['name_with_namespace'],
        $project['path_with_namespace']
    );
}
                    </code></pre>
                </section>


                <section>
                    <h2>That's a lot of projects... Filters?</h2>
                    <pre><code class="hljs php" data-line-numbers="3" data-trim>
$projects = $client
    ->projects()
    ->all(['membership'=>true]);

foreach($projects as $project) {
    printf("%d %s (%s)\n",
        $project['id'],
        $project['name_with_namespace'],
        $project['path_with_namespace']
    );
}
                    </code></pre>
                    <p class="fragment">Reminder: a user-level access token will give access to everything the user can see </p>
                </section>

                <section>
                    <h2>Contents of $project</h2>
                    <pre><code class="hljs json" data-line-numbers="" data-trim="" data-auto-animate>
{
  "id": 75547854,
  "description": null,
  "name": "Demo Talk",
  "name_with_namespace": "Frank Berger / Demo Talk",
  "path": "demo-talk",
  "path_with_namespace": "foppelfb/demo-talk",
  "created_at": "2025-10-23T14:06:26.665Z",
  "default_branch": "main",
  "tag_list": [],
  "topics": [],
  "ssh_url_to_repo": "git@gitlab.com:foppelfb/demo-talk.git",
  "http_url_to_repo": "https://gitlab.com/foppelfb/demo-talk.git",
  "web_url": "https://gitlab.com/foppelfb/demo-talk",
  "readme_url": "https://gitlab.com/foppelfb/demo-talk/-/blob/main/README.md",
  "forks_count": 0,
  "avatar_url": null,
  "star_count": 0,
  "last_activity_at": "2025-10-23T14:06:26.572Z",
  "visibility": "private",
  "namespace": {
    "id": 4658152,
    "name": "Frank Berger",
    "path": "foppelfb",
    "kind": "user",
    "full_path": "foppelfb",
    "parent_id": null,
    "avatar_url": "https://secure.gravatar.com/avatar/c9f3b5a9949724de5da93fcf1ea189dd31131a25502fb8555eb7cff3fab5cfad?s=80&d=identicon",
    "web_url": "https://gitlab.com/foppelfb"
  },
  "container_registry_image_prefix": "registry.gitlab.com/foppelfb/demo-talk",
  "_links": {
    "self": "https://gitlab.com/api/v4/projects/75547854",
    "issues": "https://gitlab.com/api/v4/projects/75547854/issues",
    "merge_requests": "https://gitlab.com/api/v4/projects/75547854/merge_requests",
    "repo_branches": "https://gitlab.com/api/v4/projects/75547854/repository/branches",
    "labels": "https://gitlab.com/api/v4/projects/75547854/labels",
    "events": "https://gitlab.com/api/v4/projects/75547854/events",
    "members": "https://gitlab.com/api/v4/projects/75547854/members",
    "cluster_agents": "https://gitlab.com/api/v4/projects/75547854/cluster_agents"
  },
  "marked_for_deletion_at": null,
  "marked_for_deletion_on": null,
  "packages_enabled": true,
  "empty_repo": false,
  "archived": false,
  "owner": {
    "id": 3583153,
    "username": "foppelfb",
    "public_email": "",
    "name": "Frank Berger",
    "state": "active",
    "locked": false,
    "avatar_url": "https://secure.gravatar.com/avatar/c9f3b5a9949724de5da93fcf1ea189dd31131a25502fb8555eb7cff3fab5cfad?s=80&d=identicon",
    "web_url": "https://gitlab.com/foppelfb"
  },
  "resolve_outdated_diff_discussions": false,
  "container_expiration_policy": {
    "cadence": "1d",
    "enabled": false,
    "keep_n": 10,
    "older_than": "90d",
    "name_regex": ".*",
    "name_regex_keep": null,
    "next_run_at": "2025-10-24T14:06:26.695Z"
  },
  "repository_object_format": "sha1",
  "issues_enabled": true,
  "merge_requests_enabled": true,
  "wiki_enabled": true,
  "jobs_enabled": true,
  "snippets_enabled": true,
  "container_registry_enabled": true,
  "service_desk_enabled": true,
  "service_desk_address": "contact-project+foppelfb-demo-talk-75547854-issue-@incoming.gitlab.com",
  "can_create_merge_request_in": true,
  "issues_access_level": "enabled",
  "repository_access_level": "enabled",
  "merge_requests_access_level": "enabled",
  "forking_access_level": "enabled",
  "wiki_access_level": "enabled",
  "builds_access_level": "enabled",
  "snippets_access_level": "enabled",
  "pages_access_level": "private",
  "analytics_access_level": "enabled",
  "container_registry_access_level": "enabled",
  "security_and_compliance_access_level": "private",
  "releases_access_level": "enabled",
  "environments_access_level": "enabled",
  "feature_flags_access_level": "enabled",
  "infrastructure_access_level": "enabled",
  "monitor_access_level": "enabled",
  "model_experiments_access_level": "enabled",
  "model_registry_access_level": "enabled",
  "package_registry_access_level": "enabled",
  "emails_disabled": false,
  "emails_enabled": true,
  "show_diff_preview_in_email": true,
  "shared_runners_enabled": true,
  "lfs_enabled": true,
  "creator_id": 3583153,
  "import_status": "none",
  "open_issues_count": 1,
  "description_html": "",
  "updated_at": "2025-10-23T14:06:28.259Z",
  "ci_config_path": "",
  "public_jobs": true,
  "shared_with_groups": [],
  "only_allow_merge_if_pipeline_succeeds": false,
  "allow_merge_on_skipped_pipeline": null,
  "request_access_enabled": true,
  "only_allow_merge_if_all_discussions_are_resolved": false,
  "remove_source_branch_after_merge": true,
  "printing_merge_request_link_enabled": true,
  "merge_method": "merge",
  "merge_request_title_regex": null,
  "merge_request_title_regex_description": null,
  "squash_option": "default_off",
  "enforce_auth_checks_on_uploads": true,
  "suggestion_commit_message": null,
  "merge_commit_template": null,
  "squash_commit_template": null,
  "issue_branch_template": null,
  "warn_about_potentially_unwanted_characters": true,
  "autoclose_referenced_issues": true,
  "max_artifacts_size": null,
  "external_authorization_classification_label": "",
  "requirements_enabled": false,
  "requirements_access_level": "enabled",
  "security_and_compliance_enabled": true,
  "compliance_frameworks": [],
  "duo_remote_flows_enabled": true,
  "permissions": {
    "project_access": {
      "access_level": 30,
      "notification_level": 3
    },
    "group_access": null
  }
}
                    </code> </pre>
                </section>
                <section>
                    <h2>What about issues?</h2>
                    <pre><code class="hljs php" data-line-numbers="|2|3|7,8" data-trim>
$issues = $client
    ->issues()
    ->all('foppelfb/demo-talk'); // id or path

foreach($issues as $issue) {
	printf("[%d] ID %d in %d: %s (%s)\n%s\n",
		$issue['id'],
		$issue['iid'],
		$issue['project_id'],
		$issue['title'],
		$issue['author']['name'],
		$issue['web_url']
	);
}
                    </code></pre>
                    <p class="fragment">There is a Pager Strategy available</p>
                </section>

                <section>
                    <h2>Idea: creating an issue from the backend/feedback form, or from inside pipelines, or ...</h2>
                    <pre><code class="hljs php" data-line-numbers="|3|4,5 " data-trim>
$issue = $client
	->issues()
	->create('foppelfb/demo-talk',[
	'title'=>$title,
	'description'=>$body,
]);
printf("[%d] ID %d in %s: %s (%s)\n%s\n",
	$issue['id'],
	$issue['iid'],
	$issue['project_id'],
	$issue['title'],
	$issue['author']['name'],
	$issue['web_url']
);
                    </code></pre>
                    <p class="fragment">Tip: use different access tokens for different tasks</p>
                </section>

                <section>
                    <h2>Available verbs/actions</h2>
                    <pre><code class="hljs php" data-line-numbers="" data-trim>
$client->projects();
$client->issues();
$client->version();
$client->deployKeys(); // readonly
$client->environments();
$client->deployments();
$client->jobs();
$client->users();
$client->groups();
$client->tags();
$client->wiki();

$client->repositories();
$client->repositoryFiles();
                    </code></pre>
                    <p>and a few more</p>
                </section>

                <section>
                    <h2>Well, that is nice... but not really beyond normal operations / management</h2>
                </section>

                <section>
                    <h2>Listing branches</h2>
                    <pre><code class="hljs php" data-line-numbers="|2,3|7" data-trim>
$branches = $client
    ->repositories()
    ->branches('foppelfb/demo-talk');
foreach($branches as $branch) {
    printf("%s : Last commit %s (%s)\n%s: %s\n\n",
        $branch['name'],
        $branch['commit']['short_id'],
        $branch['commit']['created_at'],
        $branch['commit']['author_name'],
        $branch['commit']['title']
    );
}
                    </code></pre>
                    <p class="fragment">$branch['commit'] == HEAD</p>
                </section>

                <section>
                    <h2>Creating a branch</h2>
                    <pre><code class="hljs php" data-line-numbers="|3|12-14" data-trim>
try {
  $branch = $client->repositories()
  ->createBranch('foppelfb/demo-talk',$newBranch, 'main');

  printf("%s : Last commit %s (%s)\n%s: %s\n\n",
    $branch['name'], $branch['commit']['short_id'],
    $branch['commit']['created_at'],
    $branch['commit']['author_name'],
    $branch['commit']['title']
  );

} catch(\Gitlab\Exception\ValidationFailedException $e) {
	echo $e->getMessage(),"\n";
}
                    </code></pre>
                </section>

                <section>
                    <h2>Getting the content of a file</h2>
                    <pre><code class="hljs php" data-line-numbers="|1|4,11|6" data-trim>
$file = 'my/path/file.txt';
try {
    $file = $client->repositoryFiles()
        ->getFile('foppelfb/demo-talk', $file, 'main');
} catch (\Gitlab\Exception\RuntimeException $e) {
    // $e->getCode() == 404
    $file = null;
}
try {
    $raw = $client->repositoryFiles()
        ->getRawFile('foppelfb/demo-talk', $file, 'main');
} catch (\Gitlab\Exception\RuntimeException $e) {
    $raw = null;
}
                    </code></pre>
                    <p class="fragment">this is the only (atomic) way to check if a file exists</p>
                </section>

                <section>
                    <h2>branch or reference?</h2>

                    <pre><code class="hljs php" data-trim>
                        $client->repositoryFiles()
                            ->getFile('foppelfb/demo-talk', $file, ref: 'main');
                    </code></pre>
                    <p>'main' is a reference, can be a commit hash as well as a branch</p>
                </section>

                <section>
                    <h2>Creating or updating a file</h2>
                    <pre><code class="hljs php" data-line-numbers="|2|4|6,7|9-15" data-trim>
$payload = [
	'file_path' => $file, // path/to/my/file.txt
	'branch' => $branch,
	'content' => $content, // plain text or base64
	'commit_message' => $message,
	'author_email' => 'fberger@sudhaus7.de',
	'author_name' => 'Its a me, Franky',
];
if ($raw !== null) { // update
	$result = $client->repositoryFiles()
        ->updateFile('foppelfb/demo-talk', $payload);
} else { //create
	$result = $client->repositoryFiles()
        ->createFile('foppelfb/demo-talk', $payload);
}
                    </code></pre>
                </section>

                <section>
                    <h2>Available actions for<br/>$client->repositoryFiles()</h2>

                    <ul>
                        <li>->getFile()</li>
                        <li>->getRawFile()</li>
                        <li>->createFile()</li>
                        <li>->updateFile()</li>
                        <li>->deleteFile()</li>
                    </ul>
                    <p class="fragment">All writing methods create singular commits in the repository</p>
                </section>

                <section>
                    <h2>Moving or renaming a file</h2>

                    <pre><code class="hljs php" data-line-numbers="|1,2|5-11" data-trim>
$commit = $client->repositories()
    ->createCommit( 'foppelfb/demo-talk', parameters: [
        'branch'=>$branch,
        'commit_message'=>$commitmessage,
        'actions'=>[
            [
                'action'=>'move',
                'previous_path'=>$oldfilename,
                'file_path'=> $newfilename,
            ]
        ],
        'author_email'=>'fberger@sudhaus7.de',
        'author_name'=>'The other Franky',
] );
                    </code></pre>
                    <p class="fragment">Possible actions are: create, delete, move, update, chmod</p>
                    <p class="fragment">You can add several actions and create a branch in one go</p>
                </section>

                <section>
                    <h2>Creating a merge request</h2>
                    <pre><code class="hljs php" data-line-numbers="|2-4|8|9,10|11,12|15,16" data-trim>
$parameters = [
    'remove_source_branch'=>true,
    'squash'=>true,
    'assignee_id'=>123456,
];
try {
    $mr = $client->mergeRequests()->create(
        'foppelfb/demo-talk',
        $srcBranch,
        $tgtBranch,
        $message,
        $parameters
    );
} catch (\Gitlab\Exception\RuntimeException $e) {
    // $e->getCode() == 409 -> merge request exists
    echo $e->getCode(),' ',$e->getMessage(),"\n";
}
                    </code></pre>
                    <p class="fragment">check $mr['merge_status'] and $mr['detailed_merge_status'] if you want to merge</p>
                </section>
                <section>
                    <h2>Finally: merging a mergerequest</h2>
                    <pre><code class="hljs php" data-line-numbers="|1,2|4,5|7,8|12,13" data-trim>
$mr = $client->mergeRequests()
  ->show( 'foppelfb/demo-talk', $iid);
if (
    $mr['detailed_merge_status'] === 'mergeable' &&
    (int)$mr['user']['can_merge']===1
) {
    $mrResult = $client->mergeRequests()
        ->merge('foppelfb/demo-talk', $iid, []);
    printf("%s\n",$mrResult['merged_at']);
} else {
    printf("ERROR: %s: %s - user can merge: %d\n",
        $mr['merge_status'], $mr['detailed_merge_status'],
        $mr['user']['can_merge']
    );
}
                    </code></pre>
                    <p class="fragment">rebase is available as well, of course</p>
                </section>
                <section>
                    <h2>Examples where this could be used</h2>
                    <ul>
                        <li class="fragment">Applications that can write files which exist in the repository as well</li>
                        <li class="fragment">Ticket generation from inside the Application</li>
                        <li class="fragment">Self-healing CI/CD Pipelines</li>
                        <li class="fragment">Reporting / Ticketing in the same space</li>
                        <li class="fragment">Automatic documentation in Wiki</li>
                        <li class="fragment">Automated upgrade and maintenance tasks</li>
                    </ul>
                </section>

                <section>
                    <h2>Something for TYPO3</h2>
                    <p>code711/siteconfiggitsync | EXT:siteconfiggitsync</p>
                    <p>An extension for TYPO3 that allows to keep the configuration for sites and site-sets (YAML Config files) - which can be edited through the backend by admins/editors - managed in GIT</p>
                    <p>Has support for GitHub as well</p>
                </section>
                <section>
                    <h2>Keeping ticket systems "in sync"</h2>
                    <p>Customer facing we have a Redmine system</p>
                    <p>Developers use code-related tickets in Gitlab</p>
                    <p>Tools keep the ticket relations and release management in sync</p>
                </section>

				<section>
					<h2>What are your questions?</h2>
					<img class="qr" src="qr-code.svg"/>
					<h3>Thank you, I am here all weekend</h3>
					<p>Twitter: @FoppelFB | Mastodon: @foppel@phpc.social</p>
					<p>fberger@sudhaus7.de | https://sudhaus7.de/</p>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealHighlight, RevealNotes ]
			});

		</script>

	</body>
</html>
